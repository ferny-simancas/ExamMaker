<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Editor de Ex√°menes - Estilo Word</title>
    <link href="https://fonts.googleapis.com/css2?family=Montserrat:ital,wght@0,400;0,500;0,600;0,700;1,400&display=swap" rel="stylesheet">
    
    <style>
        :root { --primary: #2563eb; --bg: #f3f4f6; --font-main: 'Montserrat', sans-serif; --header-color: #0a2445; }
        body { font-family: var(--font-main); background: var(--bg); margin: 0; padding: 20px; color: #000; }
        .container { max-width: 900px; min-height: 1200px; margin: 0 auto; background: white; padding: 40px; box-shadow: 0 4px 6px rgba(0,0,0,0.1); }
        
        /* HEADER */
        header { background-color: white; border: 3px solid var(--header-color); color: #333; margin-bottom: 20px; padding: 15px 20px; display: flex; justify-content: space-between; align-items: center; border-radius: 3px; }
        .header-left { width: 100px; display: flex; justify-content: flex-start; }
        .logo-img { width: 85px; height: 85px; object-fit: contain; }
        .header-center { flex-grow: 1; text-align: center; padding: 0 10px; }
        .header-center h1 { font-size: 18px; font-weight: 700; margin: 0; line-height: 1.2; text-transform: uppercase; color: var(--header-color); }
        .header-center .motto { font-size: 11px; font-style: italic; margin: 5px 0 10px 0; font-weight: 500; color: #555; }
        .header-center h2 { font-size: 14px; font-weight: 600; margin: 0; text-transform: uppercase; color: #333; border-bottom: 1px dashed #999; display: inline-block; padding-bottom: 2px; }
        .header-right { width: 100px; display: flex; justify-content: flex-end; align-items: center; }
        .icontec-img { width: 90px; height: 90px; object-fit: contain; display: block; }

        /* INFO & PREGUNTAS */
        .info-container { display: flex; flex-direction: column; gap: 8px; margin-bottom: 25px; width: 100%; }
        .info-row { display: flex; gap: 20px; width: 100%; }
        .info-field { display: flex; align-items: flex-end; }
        .info-field label { font-weight: 700; font-size: 11px; margin-right: 5px; white-space: nowrap; padding-bottom: 2px;}
        .field-large { flex: 7; } .field-small { flex: 3; } 
        .info-field input { width: 100%; border: none; border-bottom: 1px solid #000; background: transparent; font-size: 12px; outline: none; font-family: var(--font-main); height: 18px; }

        .question-list { counter-reset: question-counter; list-style: none; padding: 0; }
        .question-item { border: 1px solid #e5e7eb; margin-bottom: 15px; padding: 15px; border-radius: 8px; background: #fff; position: relative; }
        .question-number { font-weight: 700; margin-bottom: 5px; display: block; }
        .question-item:not([data-type="image"]):not([data-type="free_text"]):not([data-type="reading"]) .question-number::before { counter-increment: question-counter; content: counter(question-counter) ". "; }

        .edit-input, textarea { width: 100%; box-sizing: border-box; padding: 8px; border: 1px solid #ddd; border-radius: 4px; font-family: inherit; margin-bottom: 5px; background: #fff; }
        .option-row { display: flex; align-items: center; gap: 5px; margin-bottom: 5px; }
        .img-preview { max-width: 100%; max-height: 400px; display: block; margin: 10px auto; }
        .img-controls { background: #f0f9ff; padding: 10px; border-radius: 4px; border: 1px dashed #0284c7; text-align: center; }
        .opt-controls { margin-top: 5px; display: flex; gap: 5px; }
        .btn-opt { padding: 2px 8px; font-size: 10px; background: #e2e8f0; color: #333; border: 1px solid #ccc; border-radius: 3px; cursor: pointer; }

        /* CONTROLES ESTILO WORD */
        .controls { position: sticky; top: 10px; background: #fff; padding: 10px; box-shadow: 0 2px 10px rgba(0,0,0,0.1); z-index: 100; margin-bottom: 20px; border-radius: 8px; display: flex; gap: 8px; flex-wrap: wrap; align-items: center; }
        .control-group { display: flex; gap: 5px; align-items: center; border-right: 1px solid #ddd; padding-right: 10px; margin-right: 5px; }
        button { padding: 8px 12px; cursor: pointer; border: none; border-radius: 4px; font-weight: 600; font-family: var(--font-main); font-size: 12px; transition: 0.2s; }
        button:hover { opacity: 0.9; }
        
        /* Colores de botones */
        .btn-file { background: #374151; color: white; } /* Gris oscuro para archivos */
        .btn-save { background: #2563eb; color: white; } /* Azul guardar */
        
        .btn-add { background: #059669; color: white; }
        .btn-print { background: #000; color: white; }
        .btn-lang { background: #4f46e5; color: white; }
        .btn-del { background: #dc2626; color: white; font-size: 11px; margin-top: 5px; }
        .btn-upload { background: #6366f1; color: white; margin: 0 5px; }
        .btn-link { background: #8b5cf6; color: white; margin: 0 5px; }
        .btn-free-text { background: #64748b; color: white; }
        .btn-simple { background: #0891b2; color: white; }
        .btn-icontec { background: #d97706; color: white; }

        /* Estado del archivo */
        #fileStatus { font-size: 11px; color: #666; font-style: italic; margin-left: 10px; font-weight: 500;}

        @media print {
            @page { size: Legal; margin: 1.5cm 1.5cm 1.5cm 1.5cm; }
            body { background: white; padding: 0; margin: 0; font-size: 10pt !important; -webkit-print-color-adjust: exact; print-color-adjust: exact; height: auto; }
            .container { box-shadow: none; max-width: 100%; padding: 0; margin: 0; }
            .controls, .btn-del, select, .no-print-label, .img-controls, .opt-controls, #fileStatus { display: none !important; }
            header { background-color: white !important; border: 3px solid var(--header-color) !important; -webkit-print-color-adjust: exact; border-radius: 0; }
            .question-list { column-count: 2; column-gap: 30px; width: 100%; display: block; column-fill: auto; height: auto; }
            .question-item { border: none; padding: 0; margin-bottom: 20px; page-break-inside: avoid; break-inside: avoid; }
            .question-item[data-type="free_text"] textarea { font-style: normal; font-weight: 500; text-align: justify; }
            textarea, .edit-input { border: none; padding: 0; margin: 0; resize: none; background: transparent; font-family: 'Montserrat', sans-serif; font-size: 10pt; line-height: 1.3; overflow: hidden; }
            .option-row input[type="text"] { border-bottom: none; }
            .reading-text { border: 1px solid #ccc; padding: 5px; font-size: 9pt; text-align: justify; }
            .info-field input { border-bottom: 1px solid #000 !important; }
        }
    </style>
</head>
<body>

    <div class="controls">
        <div class="control-group">
            <button class="btn-file" onclick="newDocument()">üìÑ Nuevo</button>
            <button class="btn-file" onclick="openDocument()">üìÇ Abrir</button>
            <button class="btn-save" onclick="saveDocument()">üíæ Guardar</button>
            <button class="btn-save" onclick="saveDocumentAs()">üíæ Guardar Como...</button>
        </div>

        <div class="control-group">
            <button class="btn-print" onclick="window.print()">üñ®Ô∏è Imprimir</button>
            <span id="fileStatus">Documento Nuevo (Sin guardar)</span>
        </div>
        
        <div class="control-group">
            <button class="btn-lang" onclick="toggleLang()">üåê ES/EN</button>
            <button class="btn-icontec" onclick="toggleIcontec()">üèÜ Icontec</button>
        </div>

        <button class="btn-add btn-q-multi" onclick="addQ('multiple')">+ Selecci√≥n</button>
        <button class="btn-simple btn-q-simple" onclick="addQ('simple')">+ Enunciado</button>
        <button class="btn-add btn-q-read" onclick="addQ('reading')">+ Lectura</button>
        <button class="btn-add btn-q-dev" onclick="addQ('dev')">+ Abierta</button>
        <button class="btn-add btn-q-img" onclick="addQ('image')" style="background: #db2777;">+ Imagen</button>
        <button class="btn-free-text btn-q-text" onclick="addQ('free_text')">+ Texto</button>
    </div>

    <div class="container">
        <header>
            <div class="header-left">
                <img src="https://blogger.googleusercontent.com/img/a/AVvXsEgVEVyIp0mFTTIhcaIPduf4e-Mx-hTVySTbFBT-4jsrBEfNnCxqZHSaWUDJHjo5_wxYZxEDlSDrYHsHVesSoS8ajhZIUtkSqxEccS7VwBLwea46j9zedfTgGXoX-7_HZUI4Nw6-c8_p9hCL6P8ekTPInfYroWVHjl1_Cs1BUYnW2LvnLuzWPVMneO69-KW8" class="logo-img" alt="Escudo">
            </div>
            
            <div class="header-center">
                <h1>COLEGIO DE LA SAGRADA FAMILIA</h1>
                <p class="motto">"Acompa√±ando con amor, educamos el coraz√≥n"</p>
                <h2 id="examTitle" contenteditable="true">EVALUACI√ìN DE PERIODO</h2>
            </div>
            
            <div class="header-right">
                <img id="icontecLogo" src="https://barranquilla.gov.co/wp-content/uploads/2020/11/ico-cert-procesos.png" class="icontec-img" alt="Certificaci√≥n Icontec">
            </div>
        </header>

        <div class="info-container">
            <div class="info-row">
                <div class="info-field field-large">
                    <label id="lbl-student">ESTUDIANTE:</label>
                    <input type="text">
                </div>
                <div class="info-field field-small">
                    <label id="lbl-date">FECHA:</label>
                    <input type="text">
                </div>
            </div>
            <div class="info-row">
                <div class="info-field field-large">
                    <label id="lbl-teacher">DOCENTE:</label>
                    <input type="text">
                </div>
                <div class="info-field field-small">
                    <label id="lbl-grade">CURSO:</label>
                    <input type="text">
                </div>
            </div>
        </div>

        <div id="qContainer" class="question-list"></div>
    </div>

    <script>
        const container = document.getElementById('qContainer');
        const statusLabel = document.getElementById('fileStatus');
        
        // Variables de estado del archivo
        let fileHandle = null; // Referencia al archivo en disco
        let isModified = false; // ¬øHay cambios sin guardar?
        let currentLang = 'es';
        
        const t = {
            es: {
                student: "ESTUDIANTE:", date: "FECHA:", grade: "CURSO:", teacher: "DOCENTE:",
                titleDefault: "EVALUACI√ìN DE PERIODO",
                ph_q: "Enunciado...", ph_opt: "Opci√≥n", ph_read: "Texto de lectura...", 
                ph_subq: "Responda las siguientes preguntas de acuerdo con el texto:",
                ph_free: "Escribe aqu√≠ instrucciones, p√°rrafos o texto libre...",
                lbl_print: "(Espacio respuesta al imprimir)",
                btn_multi: "+ Selecci√≥n", btn_read: "+ Lectura", btn_dev: "+ Abierta", btn_img: "+ Imagen", btn_text: "+ Texto", btn_simple: "+ Enunciado",
                img_prompt_url: "Pega el enlace de la imagen:",
                btn_upload: "üìÇ Subir Foto", btn_link: "üîó Pegar URL",
                status_new: "Documento Nuevo (Sin guardar)", status_saved: "Guardado", status_mod: "(Modificado)",
                unsaved_msg: "Tienes cambios sin guardar. ¬øDeseas descartarlos?"
            },
            en: {
                student: "STUDENT:", date: "DATE:", grade: "GRADE:", teacher: "TEACHER:",
                titleDefault: "TERM EXAM",
                ph_q: "Question text...", ph_opt: "Option", ph_read: "Reading text...", 
                ph_subq: "Answer the following questions based on the text:",
                ph_free: "Write instructions, paragraphs or free text here...",
                lbl_print: "(Answer space when printing)",
                btn_multi: "+ Multiple Choice", btn_read: "+ Reading", btn_dev: "+ Open Question", btn_img: "+ Image", btn_text: "+ Text", btn_simple: "+ Statement",
                img_prompt_url: "Paste image URL:",
                btn_upload: "üìÇ Upload File", btn_link: "üîó Paste URL",
                status_new: "New Document (Unsaved)", status_saved: "Saved", status_mod: "(Modified)",
                unsaved_msg: "You have unsaved changes. Discard them?"
            }
        };

        // --- SISTEMA DE ARCHIVOS (FILE SYSTEM ACCESS API) ---

        // 1. NUEVO DOCUMENTO
        async function newDocument() {
            if (isModified && !confirm(t[currentLang].unsaved_msg)) return;
            
            // Reiniciar todo
            container.innerHTML = '';
            document.getElementById('examTitle').innerText = t[currentLang].titleDefault;
            document.querySelectorAll('.info-field input').forEach(i => i.value = '');
            document.getElementById('icontecLogo').style.display = 'block';
            
            fileHandle = null;
            isModified = false;
            updateStatus();
        }

        // 2. ABRIR DOCUMENTO
        async function openDocument() {
            if (isModified && !confirm(t[currentLang].unsaved_msg)) return;

            try {
                // Abrir selector de archivos
                [fileHandle] = await window.showOpenFilePicker({
                    types: [{ description: 'Examen JSON', accept: { 'application/json': ['.json'] } }],
                    multiple: false
                });

                // Leer archivo
                const file = await fileHandle.getFile();
                const contents = await file.text();
                const data = JSON.parse(contents);

                // Cargar datos en pantalla
                loadDataToScreen(data);
                
                isModified = false;
                updateStatus();

            } catch (err) {
                if (err.name !== 'AbortError') {
                    console.error(err);
                    alert("Error al abrir el archivo. (Nota: Esta funci√≥n requiere Chrome, Edge u Opera en PC).");
                }
            }
        }

        // 3. GUARDAR (Ctrl+S)
        async function saveDocument() {
            if (!fileHandle) {
                // Si es nuevo, usar "Guardar Como"
                return await saveDocumentAs();
            }
            
            try {
                // Crear flujo de escritura sobre el mismo archivo
                const writable = await fileHandle.createWritable();
                const data = getDataFromScreen();
                await writable.write(JSON.stringify(data, null, 2));
                await writable.close();
                
                isModified = false;
                updateStatus();
                // alert("Guardado correctamente."); // Opcional, Word no avisa, solo guarda.
            } catch (err) {
                console.error(err);
                alert("Error al guardar.");
            }
        }

        // 4. GUARDAR COMO...
        async function saveDocumentAs() {
            try {
                const opts = {
                    types: [{ description: 'Examen JSON', accept: { 'application/json': ['.json'] } }],
                    suggestedName: 'Examen-Nuevo'
                };
                
                // Abrir di√°logo de guardar
                fileHandle = await window.showSaveFilePicker(opts);
                
                // Escribir archivo
                const writable = await fileHandle.createWritable();
                const data = getDataFromScreen();
                await writable.write(JSON.stringify(data, null, 2));
                await writable.close();
                
                isModified = false;
                updateStatus();

            } catch (err) {
                if (err.name !== 'AbortError') {
                    console.error(err);
                    alert("Error al guardar.");
                }
            }
        }

        // --- FUNCIONES AUXILIARES DE DATOS ---

        function getDataFromScreen() {
            const data = [];
            document.querySelectorAll('.question-item').forEach(item => {
                const type = item.dataset.type;
                let qData = { type };
                
                if (type === 'image') qData.src = item.querySelector('img').src;
                else if (type === 'free_text') qData.text = item.querySelector('.q-text').value;
                else if (type === 'simple') qData.text = item.querySelector('.q-text').value;
                else {
                    const txt = item.querySelector('.q-text');
                    qData.text = txt ? txt.value : '';
                    
                    if (type === 'multiple') {
                        qData.options = Array.from(item.querySelectorAll('.option-row input')).map(i => i.value);
                    } else if (type === 'reading') {
                        qData.reading = item.querySelector('.q-reading').value;
                    }
                }
                data.push(qData);
            });
            
            const infoInputs = Array.from(document.querySelectorAll('.info-field input')).map(i => i.value);
            const titleText = document.getElementById('examTitle').innerText;
            const icontecVisible = document.getElementById('icontecLogo').style.display !== 'none';
            
            return { 
                questions: data, 
                title: titleText, 
                info: infoInputs, 
                lang: currentLang, 
                icontec: icontecVisible 
            };
        }

        function loadDataToScreen(saved) {
            container.innerHTML = ''; // Limpiar
            
            if(saved.lang) { currentLang = saved.lang; applyLang(); }
            if(saved.title) document.getElementById('examTitle').innerText = saved.title;
            
            const icontecImg = document.getElementById('icontecLogo');
            if(saved.icontec === false) icontecImg.style.display = 'none'; else icontecImg.style.display = 'block';
            
            if(saved.questions) saved.questions.forEach(q => addQ(q.type, q));
            
            if(saved.info) {
                const inputs = document.querySelectorAll('.info-field input');
                saved.info.forEach((val, i) => { if(inputs[i]) inputs[i].value = val; });
            }
        }

        function updateStatus() {
            const lang = t[currentLang];
            let text = "";
            
            if (!fileHandle) {
                text = lang.status_new;
            } else {
                text = fileHandle.name + " - " + lang.status_saved;
            }

            if (isModified) {
                text += " " + lang.status_mod;
                statusLabel.style.color = "#d97706"; // Naranja si hay cambios
            } else {
                statusLabel.style.color = "#059669"; // Verde si est√° guardado
            }
            
            statusLabel.innerText = text;
        }

        // Detectar cambios (Atajo de teclado Ctrl+S y marcado de modificado)
        document.addEventListener('keydown', (e) => {
            if ((e.ctrlKey || e.metaKey) && e.key === 's') {
                e.preventDefault();
                saveDocument();
            }
        });

        // Marcar como modificado al escribir
        document.addEventListener('input', () => {
            if (!isModified) {
                isModified = true;
                updateStatus();
 